<h1 id="recipe-name"><%= @recipe.name %></h1>
<p id="recipe-description"><%= @recipe.description %></p>

<h3>Ingredients</h3>
<ul id="ingredient-list">
  <% @recipe.quantities.each do |q| %>
    <li class="ingredient-item"><%= q.amount + " - " + q.ingredient.name %></li>
  <% end %>
</ul>

<h3>Instructions</h3>
<p id="recipe-instructions"><%= @recipe.instructions %></p> <br>

<p id="view-links"><%= link_to "Previous Recipe", "#", class: "js-prev", data: { id: @recipe.id } %> <span id="link-span">&emsp; &emsp; &emsp; &emsp;</span>  <%= link_to "Next Recipe", "#", class: "js-next", data: { id: @recipe.id } %></p> <br>

<% if current_user.id == @recipe.user_id %>
  <%= link_to "Delete Recipe", @recipe, method: :delete %>
<% end %>

<%= render 'review_form' %>

<%= render 'review' %>

<script id="review-template" type="text/x-handlebars-template">
  <li class="review">
    <h4 class="review_title"> {{title}} </h4>
    <p class="review_content"> {{content}} </p>
    <p class="review_date"> Reviewed On: {{updated_at}} </p>
  </li>
</script>

<script type="text/javascript" charset="utf-8">
 $(function () {
   $(".js-next").on("click", function(e) {
    e.preventDefault();
    var nextId = parseInt($(".js-next").attr("data-id")) + 1;
    getData(nextId, "next");
   });

   $(".js-prev").on("click", function(e) {
     e.preventDefault();
     var prevId = parseInt($(".js-prev").attr("data-id")) - 1;
     getData(prevId, "previous");
   });

   var getData = function(id, direction) {
    $.get("/recipes/" + id + ".json", function(json) {
    })
      .done(function (json) {
          setData(json);
          setLinks(json["id"]);
      })
      .fail(function() {
        if (direction === "next") {
          id++;
        } else if (direction === "previous") {
          id--;
        }
        getData(id);
      })
   };

   var setLinks = function(id) {
      //reset the data-id to the new recipe id
       $(".js-next").attr("data-id", id);
       $(".js-prev").attr("data-id", id);

      // reset the clickable links for next and previous 
      if (id === <%= Recipe.all.first.id %>)
      {
        $(".js-next").show();
        $("#link-span").hide();
        $(".js-prev").hide();
      } else if (id === <%= Recipe.all.last.id %>) 
      {
        $(".js-next").hide();
        $("#link-span").hide();
        $(".js-prev").show();
      } else 
      {
        $(".js-next").show();
        $("#link-span").show();
        $(".js-prev").show();
      }
   }

   setLinks(<%= @recipe.id %>)

   var setData = function(json) {
       $("#recipe-name").text(json["name"]);
       $("#recipe-description").text(json["description"]);
       $("#recipe-instructions").text(json["instructions"]);
       
       // clear and reset the ingredient list
       $("#ingredient-list").empty();
       var quantityArr = json["quantities"];
       quantityArr.forEach(function(q) {
        $("ul#ingredient-list").append("<li class='ingredient-item'>" + q.amount + " - " + q.ingredient.name + "</li>");
      }, this);
      
      // clear and reset the reviews list
      $("ul.review_list").empty();
      var reviewArr = json["reviews"];
      reviewArr.forEach(function(r) {
        var date = new Date(r.updated_at);
        date_options = {day: '2-digit', month: '2-digit', year: 'numeric'};
        $("ul.review_list").append("<li class='review'><h4 class='review_title'>" + r.title + "</h4><p class='review_content'>" + r.content + "</p><p class='review_writer'> Reviewed On: " + date.toLocaleDateString("en-US", date_options) + "</p></li>")
      }, this);
   }
 });
</script>